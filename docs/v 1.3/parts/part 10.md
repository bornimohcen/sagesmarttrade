Part 10 = Ø¶Ø¨Ø· Ø´Ø®ØµÙŠØ© Ø§Ù„Ù€ AI + UX Ø§Ù„ØªÙŠÙ„ÙŠØºØ±Ø§Ù…
Ù‡Ù†Ø§ Ù†Ø®Ù„ÙŠ Ø§Ù„Ø¨ÙˆØª Ù„Ø·ÙŠÙØŒ Ø°ÙƒÙŠØŒ ÙˆÙ…ÙÙ‡ÙˆÙ… Ø¨Ø¯Ù„ Ù…Ø§ ÙŠÙƒÙˆÙ† Ù…Ø¬Ø±Ø¯ Ù„ÙˆØ¬Ø§Øª Ù…Ù…Ù„Ø© ğŸ˜„

Ø±Ø­ Ø£Ù‚Ø³Ù… Part 10 ÙƒØ°Ø§:

Ø§Ù„Ù‡Ø¯Ù Ù…Ù† Ø§Ù„Ø¬Ø²Ø¡ 10

ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù€ Prompts Ù„Ù„Ù€ AI (Ù‚Ø¨Ù„ Ø§Ù„ØµÙÙ‚Ø©ØŒ Ø¨Ø¹Ø¯ Ø§Ù„ØµÙÙ‚Ø©ØŒ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±)

Ø¯Ø¹Ù… Ù„ØºØªÙŠÙ† (Ø¹Ø±Ø¨ÙŠ + Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ) Ø¨Ø£Ø³Ù„ÙˆØ¨ Ù…ØªÙ‘Ø³Ù‚

ØªØµÙ…ÙŠÙ… UX Ù„Ø¨ÙˆØª Ø§Ù„ØªÙŠÙ„ÙŠØºØ±Ø§Ù… (Ø§Ù„Ø£ÙˆØ§Ù…Ø± + Ø§Ù„Ø£Ø²Ø±Ø§Ø± + Ø§Ù„Ø±Ø¯ÙˆØ¯)

Ø±Ø¨Ø· Telegram Ù…Ø¹ AI layer (explain, review, alerts)

Prompt Ø¬Ø§Ù‡Ø² ØªØ¹Ø·ÙŠÙ‡ Ù„Ù€ AI Agent ÙŠØ¹Ø¯Ù‘Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ù€ Prompts

1ï¸âƒ£ Ù‡Ø¯Ù Part 10

Ø§Ù„Ø¢Ù† Ø¹Ù†Ø¯Ùƒ:

Engine ØªØ¯Ø§ÙˆÙ„ + RiskManager + Strategies + CompositeSignal âœ…

Ø·Ø¨Ù‚Ø© AI (SignalAdvisor + TradeExplainer) Ø¨Ø´ÙƒÙ„ Ø£ÙˆÙ‘Ù„ÙŠ âœ…

ÙÙŠ Part 10 Ù†Ø±ÙŠØ¯:

Prompts Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ù€ AI:

Ù‚Ø¨Ù„ Ø§Ù„ØµÙÙ‚Ø© (AI ÙŠØ±Ø§Ø¬Ø¹Ù‡Ø§)

Ø¨Ø¹Ø¯ ÙØªØ­ Ø§Ù„ØµÙÙ‚Ø© (AI ÙŠØ´Ø±Ø­Ù‡Ø§)

Ø¨Ø¹Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙÙ‚Ø© (AI ÙŠØ±Ø§Ø¬Ø¹Ù‡Ø§ ÙˆÙŠØ¹Ø·ÙŠ Ø¯Ø±ÙˆØ³)

Alerts Ù„Ù„Ù…Ø®Ø§Ø·Ø± (Ù…Ø«Ù„Ø§Ù‹ ÙŠÙˆÙ… Ø®Ø§Ø³Ø± Ø¨Ù‚ÙˆÙ‘Ø© Ø£Ùˆ drawdown Ø¹Ø§Ù„ÙŠ)

Telegram UX:

Ø£ÙˆØ§Ù…Ø± ÙˆØ§Ø¶Ø­Ø©

Ø±Ø¯ÙˆØ¯ Ù…Ø±ØªØ¨Ø© ÙˆÙ…Ø®ØªØµØ±Ø©

Ø£Ø²Ø±Ø§Ø± Inline (Ù…Ø«Ù„Ø§Ù‹ â€œØ§Ø´Ø±Ø­ Ø§Ù„ØµÙÙ‚Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©â€ØŒ â€œØ£Ø¸Ù‡Ø± Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©â€)

Ø¯Ù…Ø¬ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ù…Ø¹ AI (Ù…Ùˆ Ø¨Ø³ Ø£Ø±Ù‚Ø§Ù… Ø¬Ø§Ù…Ø¯Ø©)

2ï¸âƒ£ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù€ Prompts Ù„Ù„Ù€ AI
ğŸ§  2.1 â€” Prompt Ù…Ø­Ø³Ù‘Ù† Ù„Ù€ AISignalAdvisor (Ù‚Ø¨Ù„ Ø§Ù„ØµÙÙ‚Ø©)

ÙÙŠ Part 9 Ø¹Ù…Ù„Ù†Ø§ Prompt Ø£Ø³Ø§Ø³ÙŠ. Ø§Ù„Ø¢Ù† Ù†ØµÙ…Ù…Ù‡ Ø£ÙˆØ¶Ø­ØŒ Ù…Ø¹ Ø£Ø³Ù„ÙˆØ¨ Ø«Ø§Ø¨ØªØŒ + Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ù„ØºØ© Ù…Ø²Ø¯ÙˆØ¬Ø©.

ÙÙƒØ±Ø©:

Ù†Ø­Ø¯Ø¯ â€œØ´Ø®ØµÙŠØ©â€ Ø§Ù„Ù€ AI:

Ù‡Ø§Ø¯Ø¦ØŒ Ù…Ø­Ø§ÙØ¸ØŒ ÙŠÙ‡Ù…Ù‘Ù‡ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±

Ù†Ø­Ø¯Ø¯ Ø´ÙƒÙ„ Ø§Ù„Ø±Ø¯Ù‘ Ø¨Ø¯Ù‚Ø© (decision + reasoning + suggestions)

Template Ø¬Ø¯ÙŠØ¯ (ØªØ¶Ø¹Ù‡ ÙÙŠ build_signal_prompt Ø¨Ø¯Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…):
You are "SAGE-RISK-AI", an experienced trading risk advisor.
Your style:
- Conservative and risk-aware.
- Clear, concise, and non-hype.
- You never encourage over-leverage or revenge trading.

You receive a proposed trade based on quantitative and news/social signals.

TRADE CONTEXT:
- Symbol: {symbol}
- Strategy: {strategy_name}

QUANT SIGNALS:
- SMA: {q.sma:.4f}
- EMA: {q.ema:.4f}
- RSI: {q.rsi:.2f}
- ATR: {q.atr:.4f}
- Volatility: {q.volatility:.4f}
- Regime: {q.regime}

NEWS / NLP:
{nlp_part}

SOCIAL:
{social_part}

COMPOSITE SIGNAL:
- Direction: {signal.direction}
- Score: {signal.score:.4f} (range approx -1.0 to +1.0)
- Confidence: {signal.confidence:.3f} (0 = low, 1 = very high)

RISK STATE:
- Current equity: {risk.equity:.2f}
- Start equity: {risk.equity_start:.2f}
- Daily PnL: {risk.daily_pnl:.2f}
- Open trades: {risk.open_trades}
- Total open notional: {risk.total_open_notional:.2f}

TASK:
1. Evaluate if entering this trade NOW is reasonable from a risk perspective.
2. Choose one decision:
   - "approve" â†’ trade looks acceptable.
   - "caution" â†’ trade is acceptable but with warnings.
   - "reject" â†’ better to stay flat now.
3. Optionally suggest a better direction: long, short, or flat.
4. Optionally suggest an adjusted confidence between 0 and 1.
5. Explain your reasoning in 2â€“3 short sentences.

IMPORTANT:
- Focus on risk, not hype.
- If daily PnL is already strongly negative or exposure is high, lean towards "caution" or "reject".

RESPONSE FORMAT (plain text, no JSON, no backticks):

decision: <approve|caution|reject>
suggested_direction: <long|short|flat|none>
suggested_confidence: <0.0-1.0 or 'none'>
reason: <2-3 sentences explanation>


ØªÙ‚Ø¯Ø± ØªØ¶ÙŠÙ Ù…Ù„Ø§Ø­Ø¸Ø©: â€œif language setting is 'ar', add a short Arabic summary in one sentence at the end.â€

ğŸ§  2.2 â€” Prompt Ù…Ø­Ø³Ù‘Ù† Ù„Ù€ Trade Explainer (Ø¨Ø¹Ø¯ ÙØªØ­ Ø§Ù„ØµÙÙ‚Ø©)

Ø¨Ø¯Ù„ ÙƒÙ„Ø§Ù… Ø¹Ø§Ù…ØŒ Ù†ÙØ¶ÙŠÙ:

Ø³Ø¨Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„

Ø¯ÙˆØ± Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©

ÙƒÙŠÙ Ù†Ø±Ø§Ù‚Ø¨ Ø§Ù„ØµÙÙ‚Ø©

Template Ø¬Ø¯ÙŠØ¯ Ù„Ù€ _build_open_trade_prompt:

You are "SAGE-EXPLAIN-AI", an AI trading assistant.
Your task is to explain a newly opened trade to a human trader who understands basics but is not a quant expert.

TRADE:
- Symbol: {symbol}
- Strategy: {strategy_name}
- Side: {side} (long = buy expecting price up, short = sell expecting price down)
- Quantity: {qty:.4f}
- Entry price: {price:.4f}

QUANT SIGNALS (last window):
- SMA: {q.sma:.4f}
- EMA: {q.ema:.4f}
- RSI: {q.rsi:.2f}
- ATR: {q.atr:.4f}
- Volatility: {q.volatility:.4f}
- Regime: {q.regime}

COMPOSITE SIGNAL:
- Direction: {signal.direction}
- Score: {signal.score:.4f}
- Confidence: {signal.confidence:.3f}

NEWS / NLP:
{nlp_text}

SOCIAL:
{social_text}

RISK CONTEXT:
- Current equity: {risk.equity:.2f}
- Start equity: {risk.equity_start:.2f}
- Open trades: {risk.open_trades}
- Total open notional: {risk.total_open_notional:.2f}

TASK:
1. Provide a short title summarizing the idea of the trade in ONE line.
2. Provide a 3â€“5 sentence explanation of:
   - Why the system entered this trade now.
   - How the quantitative and news/social signals support the idea.
   - How aggressive or conservative the trade is.
3. Give 2â€“4 key risks to monitor (in bullet points).
4. Give 1â€“3 short notes or suggestions for managing the trade (e.g., what to watch, when to reduce risk).

LANGUAGE:
- Write in English, but add ONE short Arabic sentence at the end of SUMMARY summarizing the idea.

RESPONSE FORMAT (plain text, no JSON, no markdown):

TITLE: <short title>
SUMMARY: <one or two paragraphs including the Arabic sentence at the end>
RISKS:
- <risk 1>
- <risk 2>
- <risk 3>
NOTES:
- <note 1>
- <note 2>
- <note 3>


ÙƒØ°Ø§ ØªØ­ØµÙ„ Explanation Ø­Ù„ÙˆØ© + ÙÙŠÙ‡Ø§ Ø¬Ù…Ù„Ø© Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø³ÙŠØ·Ø© ØªØ¹Ø·ÙŠ Ø±ÙˆØ­ Ù„Ù„Ø¨ÙˆØª.

ğŸ§  2.3 â€” Prompt Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØµÙÙ‚Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (Post-Trade Review)

Ù‡Ø°Ø§ Ù…Ù…ÙƒÙ† ØªØ­Ø·Ù‡ ÙÙŠ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ ai/trade_reviewer.py Ø£Ùˆ ØªØ¶ÙŠÙÙ‡ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„.

Template:

You are "SAGE-REVIEW-AI", an AI trading mentor.
You will review a completed trade and extract lessons.

TRADE SUMMARY:
- Symbol: {symbol}
- Strategy: {strategy_name}
- Side: {side}
- Entry price: {entry_price:.4f}
- Exit price: {exit_price:.4f}
- Quantity: {qty:.4f}
- Realized PnL: {pnl:.2f}
- Holding period: {holding_period_minutes} minutes

ENTRY SIGNAL SNAPSHOT:
- Composite direction at entry: {entry_signal.direction}
- Score: {entry_signal.score:.4f}
- Confidence: {entry_signal.confidence:.3f}
- Quant regime: {entry_signal.quant.regime}
- RSI at entry: {entry_signal.quant.rsi:.2f}

RISK CONTEXT AT ENTRY:
- Equity: {entry_risk_equity:.2f}
- Open trades: {entry_open_trades}

TASK:
1. Classify the outcome as win, loss, or breakeven.
2. Give a 2â€“4 sentence review explaining what went right or wrong.
3. Provide 2â€“4 concrete improvements (rules, filters, or risk tweaks) that could help similar trades in the future.
4. Keep the tone calm, objective, and educational.

RESPONSE FORMAT:

OUTCOME: <win|loss|breakeven>
LESSON: <one paragraph with the main lesson>
IMPROVEMENTS:
- <improvement 1>
- <improvement 2>
- <improvement 3>

3ï¸âƒ£ Ø¯Ø¹Ù… Ù„ØºØªÙŠÙ† (Ø¹Ø±Ø¨ÙŠ + Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)

Ø¨Ø¯Ù„ Ù…Ø§ ØªØºÙŠÙ‘Ø± ÙƒÙ„ Ù…Ø±Ù‘Ø©ØŒ Ø®Ù„Ù‘ÙŠ ÙÙŠ settings:

ai:
  language: "mix"   # options: "en", "ar", "mix"


ÙˆÙÙŠ Ø§Ù„Ù€ prompts:

Ø¥Ø°Ø§ language == "en" â†’ ÙƒÙ„ Ø§Ù„Ù†Øµ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ

Ø¥Ø°Ø§ language == "ar" â†’ ØªØ·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù€ AI ÙŠØ´Ø±Ø­ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŒ ÙˆÙŠØ¶ÙŠÙ Ù…ØµØ·Ù„Ø­Ø§Øª Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©

Ø¥Ø°Ø§ mix â†’ Ø²ÙŠ Ù…Ø§ ÙÙˆÙ‚: Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ø£Ø³Ø§Ø³ÙŠ + Ø¬Ù…Ù„Ø© Ø¹Ø±Ø¨ÙŠØ© Ø§Ø®ØªØµØ§Ø± ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©

ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù„ ÙÙŠ build_signal_prompt Ùˆ _build_open_trade_prompt:

ØªØ¶ÙŠÙ Ø´Ø±Ø· Ø¨Ø³ÙŠØ·:

Ù„Ùˆ Ø§Ù„Ù„ØºØ© "ar":

ØªØ¶ÙŠÙ ÙÙŠ Ø§Ù„Ù€ TASK: â€œUse Modern Standard Arabic as the main language, with English terms for technical indicators (RSI, EMA, ATR...).â€

4ï¸âƒ£ ØªØµÙ…ÙŠÙ… UX Ù„Ø¨ÙˆØª Ø§Ù„ØªÙŠÙ„ÙŠØºØ±Ø§Ù…

Ø®Ù„ÙŠ Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ø·ÙŠÙƒ:

Ø£ÙˆØ§Ù…Ø± Ø±Ø¦ÙŠØ³ÙŠØ©:

/start

ÙŠØ±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ + Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆØ§Ù…Ø±

/status

Ù…Ù„Ø®Ù‘Øµ Ø³Ø±ÙŠØ¹:

equity

daily PnL

open trades

last trade

/open

Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© (symbol, side, entry, PnL%)

/closed

Ø¢Ø®Ø± N ØµÙÙ‚Ø§Øª Ù…ØºÙ„Ù‚Ø©

/signals

Ø¢Ø®Ø± CompositeSignal Ù„ÙƒÙ„ Ø±Ù…Ø²

/ai_review

Ø±Ø£ÙŠ AISignalAdvisor ÙÙŠ Ø¢Ø®Ø± ØµÙÙ‚Ø© / Ø¥Ø´Ø§Ø±Ø©

/explain_last

ÙŠØ³ØªØ®Ø¯Ù… AITradeExplainer Ù„Ø´Ø±Ø­ Ø¢Ø®Ø± ØµÙÙ‚Ø©

/risk

Ù…Ù„Ø®Øµ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø®Ø§Ø·Ø± (max_risk_per_trade_pct, max_daily_loss_pct, ...)

Ø£Ø²Ø±Ø§Ø± Inline (InlineKeyboard)

Ù…Ø«Ø§Ù„:

Ø¨Ø¹Ø¯ ÙØªØ­ ØµÙÙ‚Ø©ØŒ Ø§Ù„Ø¨ÙˆØª ÙŠØ±Ø³Ù„:

ØªÙ… ÙØªØ­ ØµÙÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ù„Ù‰ BTCUSD (short @ 40,000, Ø­Ø¬Ù… 0.01).

Ù…Ø¹ Ø£Ø²Ø±Ø§Ø±:

ğŸ” Ø´Ø±Ø­ Ø§Ù„ØµÙÙ‚Ø© (AI) â†’ ÙŠØ±Ø³Ù„ Ù†ØªÙŠØ¬Ø© explain_open_trade

ğŸ“Š ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨ â†’ ÙŠÙ†ÙÙ‘Ø° /status

ğŸ§  Ø±Ø£ÙŠ AI ÙÙŠ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© â†’ ÙŠØ±Ø³Ù„ Ø¢Ø®Ø± AISignalAdvice

ØªÙ‚Ø¯Ø± ÙÙŠ python-telegram-bot ØªØ³ØªØ®Ø¯Ù…:

from telegram import InlineKeyboardButton, InlineKeyboardMarkup

keyboard = [
    [
        InlineKeyboardButton("ğŸ” Ø´Ø±Ø­ Ø§Ù„ØµÙÙ‚Ø© (AI)", callback_data="explain_last"),
        InlineKeyboardButton("ğŸ“Š ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨", callback_data="status"),
    ],
]
reply_markup = InlineKeyboardMarkup(keyboard)
await bot.send_message(chat_id=chat_id, text=msg, reply_markup=reply_markup)


ÙˆÙÙŠ handler Ù„Ù€ callback_data:

Ù„Ùˆ "explain_last" â†’ ØªØ³ØªØ¯Ø¹ÙŠ explain_open_trade ÙˆØªØ±Ø³Ù„

Ù„Ùˆ "status" â†’ ØªØ±Ø³Ù„ /status info

5ï¸âƒ£ Ø±Ø¨Ø· Telegram Ù…Ø¹ AI layer (Ø¨Ø´ÙƒÙ„ Ø¹Ù…Ù„ÙŠ)
Ù…Ø«Ø§Ù„: Ø¹Ù†Ø¯ ÙØªØ­ ØµÙÙ‚Ø© ÙÙŠ trading loop

Ø¨Ø¹Ø¯:

order = broker.submit_order(...)
position = broker.get_position(order.id)


ØªØ¹Ù…Ù„:

from sagetrade.ai.trade_explainer import explain_open_trade
from sagetrade.telegram.notify import notify_new_trade

# Ø§Ø­ÙØ¸ composite ÙÙŠ position.meta Ù…Ø«Ù„Ø§Ù‹
position.meta["composite_signal"] = composite
position.meta["strategy_name"] = strat.name

# AI explanation (Ø§Ø®ØªÙŠØ§Ø±ÙŠ ÙÙŠ background, Ù„ÙƒÙ† Ø¹Ù†Ø¯Ù†Ø§ Ù„Ø§Ø²Ù… Ø§Ù„Ø¢Ù† Ù…Ø¨Ø§Ø´Ø±Ø©)
expl = explain_open_trade(
    symbol=symbol,
    strategy_name=strat.name,
    side=side,
    qty=qty,
    price=price,
    signal=composite,
    risk=risk_state,
)

# Ø¥Ø±Ø³Ø§Ù„ Ù„ØªÙŠÙ„ÙŠØºØ±Ø§Ù…:
notify_new_trade(position, expl)


ÙˆÙÙŠ notify_new_trade ØªØ¨Ù†ÙŠ Ø±Ø³Ø§Ù„Ø© Ù„Ø·ÙŠÙØ©:

def notify_new_trade(position, expl: AITradeExplanation):
    text = (
        f"ğŸš¨ *ØµÙÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø©*\n"
        f"Ø±Ù…Ø²: `{position.symbol}`\n"
        f"Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©: *{expl.strategy_name}*\n"
        f"Ø§Ù„Ø§ØªØ¬Ø§Ù‡: *{position.side.upper()}*\n"
        f"Ø§Ù„Ø³Ø¹Ø±: `{position.entry_price:.4f}`\n"
        f"Ø§Ù„ÙƒÙ…ÙŠØ©: `{position.qty:.4f}`\n\n"
        f"*{expl.title}*\n"
        f"{expl.summary}\n\n"
        f"*Ø§Ù„Ù…Ø®Ø§Ø·Ø±:*\n" + "\n".join(f"- {r}" for r in expl.risks)
    )
    # + InlineKeyboardMarkup Ù„Ù„Ø£Ø²Ø±Ø§Ø±

6ï¸âƒ£ Prompt Ø¬Ø§Ù‡Ø² Ù„Ù€ AI Agent Ù„ØªÙ†ÙÙŠØ° Part 10

Ø§Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ù‡Ø°Ø§ ÙƒÙ…Ø§ Ù‡Ùˆ Ù„ÙˆÙƒÙŠÙ„ AI Ø§Ù„Ù„ÙŠ Ø´ØºØ§Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙŠØ¨Ùˆ:

You are a senior Python developer and prompt engineer working on my project SAGE SmartTrade.

CONTEXT:
- The project now has:
  - CompositeSignal, strategies, RiskManager, trading loop.
  - AI layer with AISignalAdvisor and AITradeExplainer (Phase 9).
  - A Telegram bot skeleton.
- I want to improve both:
  - AI prompts (quality & style)
  - Telegram UX (commands, inline buttons, AI-powered replies)

TASK:

1) Improve the prompt used in `sagetrade/ai/signal_advisor.py` (build_signal_prompt):
   - Define the persona "SAGE-RISK-AI":
     - Conservative, risk-aware, no hype.
   - Include clear instructions:
     - Focus on risk, daily PnL, exposure, and confidence.
     - Bias towards "caution" or "reject" when daily losses or exposure are high.
   - Require the response format:

     decision: <approve|caution|reject>
     suggested_direction: <long|short|flat|none>
     suggested_confidence: <0.0-1.0 or 'none'>
     reason: <2-3 sentences explanation>

   - Integrate `settings.ai.language` with options "en", "ar", "mix":
     - For "en": English only.
     - For "ar": Modern Standard Arabic with English technical terms.
     - For "mix": English main text + one short Arabic sentence summarizing the idea.

2) Improve the prompt in `sagetrade/ai/trade_explainer.py` (_build_open_trade_prompt):
   - Define persona "SAGE-EXPLAIN-AI":
     - Friendly, clear, and non-technical.
   - Require response format:

     TITLE: <short title>
     SUMMARY: <one or two paragraphs>
     RISKS:
     - <risk 1>
     - <risk 2>
     NOTES:
     - <note 1>
     - <note 2>

   - For language "mix":
     - Add ONE short Arabic sentence at the end of SUMMARY summarizing the idea.

3) Optionally add a new module `sagetrade/ai/trade_reviewer.py`:
   - Define a function that takes:
     - trade data (entry, exit, pnl, holding period)
     - entry CompositeSignal and risk context
   - Builds a prompt for "SAGE-REVIEW-AI" with response format:

     OUTCOME: <win|loss|breakeven>
     LESSON: <one paragraph>
     IMPROVEMENTS:
     - <improvement 1>
     - <improvement 2>

4) Telegram UX:
   - In `sagetrade/telegram` (e.g. handlers.py or bot.py), implement:
     - Commands:
       - `/status`: send current equity, daily PnL, open trades count, last trade.
       - `/open`: list open positions (symbol, side, entry, unrealized PnL).
       - `/closed`: list last N closed trades (symbol, side, PnL).
       - `/signals`: list latest CompositeSignal per symbol (direction, score, confidence).
       - `/ai_review`: show latest AISignalAdvice (decision + reason).
       - `/explain_last`: call AITradeExplainer on the last trade and send the explanation.
   - Implement inline buttons for a new trade notification:
     - "ğŸ” Ø´Ø±Ø­ Ø§Ù„ØµÙÙ‚Ø© (AI)" â†’ triggers the same logic as `/explain_last`.
     - "ğŸ“Š ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨" â†’ triggers the same logic as `/status`.

5) Integration:
   - In the trading loop:
     - After a trade is opened and a `CompositeSignal` is available:
       - store the composite signal and strategy name inside the position metadata.
       - call `explain_open_trade(...)` to generate an AI explanation.
       - pass both the position and explanation into a Telegram notifier helper (e.g. `notify_new_trade`).
   - In Telegram handlers:
     - Implement `/explain_last` and the inline callback "explain_last" to:
       - fetch the last position.
       - retrieve the stored CompositeSignal.
       - call `explain_open_trade(...)` if explanation not already cached.
       - send a nicely formatted message (Markdown) with title, summary, risks, notes.

STYLE:
- Keep prompts in clear multiline strings using `dedent`.
- Respect `settings.ai.language` when generating prompts.
- Use existing logging and config utilities.
- Output updated files as code blocks with paths, for example:

  # FILE: sagetrade/ai/signal_advisor.py
  ...
  # FILE: sagetrade/ai/trade_explainer.py
  ...
  # FILE: sagetrade/ai/trade_reviewer.py
  ...
  # FILE: sagetrade/telegram/handlers.py
  ...
  # FILE: scripts/paper_trade_loop.py
  ...
